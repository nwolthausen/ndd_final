---
title: "NDD ADA Final"
author: "Noah Wolthausen"
date: "11/23/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

Data cleaning and recoding
```{r}
library(readr)
ndd_ada <- read_csv("/Users/noahwolthausen/Desktop/vc_ada_final/ndd_ada.csv")
View(ndd_ada)

library(tidyverse)
library(dplyr)

#removing blank rows
ndd_ada <-ndd_ada[-c(201:382),]
ndd_ada <-ndd_ada[-c(176),]

#make diarrhea a factor
ndd_ada$diarrhea_any_type_b<- factor(ndd_ada$diarrhea_any_type_b, levels = c(0:1), labels = c("No", "Yes"))
table(ndd_ada$diarrhea_any_type_b)

#make sex a factor
ndd_ada <- ndd_ada %>%
  mutate(sex = case_when(sex==1 ~ 0, sex==2 ~ 1),
         sex = factor(sex, 0:1, c("Male", "Female")))

#new binary variable for maternal education; Primary or less, Secondary or more
ndd_ada$primary_matedu<- ifelse(ndd_ada$maternal_education<=2, 0,
                                ifelse(ndd_ada$maternal_education>=3, 1, NA))


ndd_ada$primary_matedu<- factor(ndd_ada$primary_matedu, levels = c(0,1), labels = c("Primary education or less", "Secondary education or above"))

#recoding of HH income
ndd_ada$hh_income<- factor(ndd_ada$hh_income, levels = c(1:4), labels = c("500-1000 Dola Ayisien", "1001-1500 Dola Ayisien", "1501-2000 Dola Ayisien", "2001+ Dola Ayisien"))


#recoding of variables for wealth score. 1= Yes, 0= No

#rent/own a home 
ndd_ada$wi_home<- ifelse(ndd_ada$home<=2, 1, 
                         ifelse(ndd_ada$home==3, 0, NA))
#number of people in househole; less than 5, more than 6 
ndd_ada$wi_hhpersons<- ifelse(ndd_ada$number_living_hh<=5, 1,
                              ifelse(ndd_ada$number_living_hh>=6, 0, NA))
#own chickens
ndd_ada$wi_chkn<- ifelse(ndd_ada$chicken...33<=2, 1,
                         ifelse(ndd_ada$chicken...33==3, 0, NA))
#own goats or pigs
ndd_ada$wi_goats_pigs<- ifelse(ndd_ada$goats_pigs <=2, 1,
                         ifelse(ndd_ada$goats_pigs==3, 0, NA))
#own cellphone
ndd_ada$wi_cellphone<- ifelse(ndd_ada$telephone <=2, 1,
                         ifelse(ndd_ada$telephone ==3, 0, NA))
#own tv
ndd_ada$wi_tv<- ifelse(ndd_ada$tv <=2, 1,
                         ifelse(ndd_ada$tv ==3, 0, NA))
#own fridge
ndd_ada$wi_fridge<- ifelse(ndd_ada$refrigerator <=2, 1,
                         ifelse(ndd_ada$refrigerator ==3, 0, NA))
#have access to electricity
ndd_ada$wi_elec<- ifelse(ndd_ada$electricity <=2, 1,
                         ifelse(ndd_ada$electricity ==3, 0, NA))
#floor composition; 1= concrete/ceramic, 0=earth/rocks
ndd_ada$wi_floor<- ifelse(ndd_ada$house_floor >=2, 1,
                         ifelse(ndd_ada$house_floor ==1, 0, NA))
#roof composition; 1= concrete 0= aluminum
ndd_ada$wi_roof<- ifelse(ndd_ada$house_roof==2, 1,
                         ifelse(ndd_ada$house_roof ==3, 0, NA))
table(ndd_ada$wi_roof)
#toilet type; 1= Pit Latrine With Slab/Ventilated Pit Latrine/Automatic Toilet 0= Pit Latrine Without Slab/Open Holes/Composting Toilet/Bucket Toilet/Hanging Toilet/Bush/GroundRiver/Stream
ndd_ada$wi_toilet<- ifelse(ndd_ada$toilet_type <=3, 1,
                         ifelse(ndd_ada$toilet_type >=4, 0, NA))


```


```{r}
#creating new dataframe with all variables of interest

work_ndd<- data.frame(ndd_ada$id, ndd_ada$age_months_b, ndd_ada$sex,
                      ndd_ada$primary_matedu, ndd_ada$hh_income, ndd_ada$diarrhea_any_type_b, 
                      ndd_ada$wi_home, ndd_ada$wi_hhpersons, ndd_ada$wi_chkn, 
                      ndd_ada$wi_cellphone, ndd_ada$wi_elec, ndd_ada$wi_floor, 
                      ndd_ada$wi_fridge, ndd_ada$wi_roof, ndd_ada$wi_toilet, 
                      ndd_ada$wi_tv)



#checking for missing values
library(VIM) 
library(mice) 
library(lattice)

md.pattern(work_ndd, rotate.names=TRUE)

print(work_ndd$ndd_ada.diarrhea_any_type_b)

#removing 20 cases due to missing values 

complete_ndd<- na.omit(work_ndd)
str(complete_ndd)






```

PCA Wealth Index from binary asset variables
```{r}
#new datafram with only variables for pca
wi_ndd<- complete_ndd[,7:16]


#running PCA with variables

pc.ndd<- princomp(wi_ndd, cor = TRUE)
names(pc.ndd)

#summary
summary(pc.ndd)

#eigenvalues
eigenvectors <- pc.ndd$loadings
eigenvalues <- pc.ndd$sdev *pc.ndd$sdev

round(cor(wi_ndd, pc.ndd$scores), 3)

#creating the index with PCA1 which explains the most variance
index=pc.ndd$scores[,1]

#continuous variable of WI
complete_ndd<-mutate(complete_ndd,WI_scores=as.numeric(index))

#PCA1 is broken down into 5 quintiles to represent wealth. 1st quintile represents the least wealthy 20% and 5th quintile is the most wealthy 20%.
nlab<-c(1,2,3,4,5)

complete_ndd<-mutate(complete_ndd,WI_quintile=as.factor(cut(index,breaks=5,labels=nlab)))

#make the wealth index a factor
factor(complete_ndd$WI_quintile, levels = c(1:5))


summary(complete_ndd$WI_quintile)

#checking distrubtion of wealth scores by diarrhea status
complete_ndd %>% 
ggplot(aes(x =  ndd_ada.diarrhea_any_type_b, y = WI_scores)) +
      geom_boxplot(aes(fill = ndd_ada.diarrhea_any_type_b)) +
      labs(x = "Diarrhea status", y = "Wealth Index scores") +
      theme_bw()




```

Logistic Regression for wealth index scores and wealth index quintiles
```{r}

#load packages for logistic regression
library(ROCR)
library(odds.n.ends)
library(blorr)
library(lmtest)
library(car)



#Logistic regression for diarrhea and wealth scores
cont_wealthlogit<- glm(ndd_ada.diarrhea_any_type_b ~ WI_scores, data = complete_ndd,
                    family = "binomial")
summary(cont_wealthlogit)

#ORs and 95% CIs
ORwi<-exp(cbind(OR = coef(cont_wealthlogit), confint(cont_wealthlogit))) 
ORwi 

odds.n.ends(cont_wealthlogit)

#testing linearity assumption
complete_ndd <- complete_ndd %>%
  mutate(WI_scores.times.logscores = WI_scores * log(WI_scores))

boxTidwellWI_scores <- glm(ndd_ada.diarrhea_any_type_b ~ WI_scores + WI_scores.times.logscores, data=complete_ndd, family="binomial") #Box Tidwell technique

summary(boxTidwellWI_scores)
#assumption of linearity is met

#check for undue influence
plot(cont_wealthlogit, which=4, id.n=5, col="red") 

#Although some cases present some influence, they will be left in the model to preserve sample size

#Model fits
blr_model_fit_stats(cont_wealthlogit)

#Hosmer lemeshow goodness of fit test: a significant p value indicates a bad fit
blr_test_hosmer_lemeshow(cont_wealthlogit) 
 #does meet goodness of fit assumption

#Logistic regression with wealth index quintiles

wi_quintlogit<- glm(ndd_ada.diarrhea_any_type_b ~ WI_quintile, data = complete_ndd,
                    family = "binomial")
summary(wi_quintlogit)

#ORs and 95% CIs
ORwi<-exp(cbind(OR = coef(wi_quintlogit), confint(wi_quintlogit))) 
ORwi 

odds.n.ends(wi_quintlogit)

# the odds of having diarrhea for children in the 2nd quintile is 57.6% lower than children in the first quintile, not significant
# the odds of having diarrhea for children in the 3rd quintile is 51.7% lower than children in the first quintile, not significant
# the odds of having diarrhea for children in the 4th quintile is 28.2% lower than children in the first quintile, not significant
# the odds of having diarrhea for children in the 5th quintile is 41.7% lower than children in the first quintile, not significant



```
```{r}
#Multivariate model with diarrhea as the dependent variable and Wealth index quintiles, maternal education, age and sex as the independent variables

MV_wi_quintlogit<- glm(ndd_ada.diarrhea_any_type_b ~ WI_quintile + ndd_ada.primary_matedu + ndd_ada.age_months_b + ndd_ada.sex, data = complete_ndd,
                    family = "binomial")
summary(MV_wi_quintlogit)

ORwi_MV<-exp(cbind(OR = coef(MV_wi_quintlogit), confint(MV_wi_quintlogit))) 
ORwi_MV 

odds.n.ends(MV_wi_quintlogit)

#model improves but is not significant

#model with interaction terms
MV_wi_INTlogit<- glm(ndd_ada.diarrhea_any_type_b ~ WI_quintile + ndd_ada.primary_matedu + ndd_ada.age_months_b + ndd_ada.sex, + WI_quintile*ndd_ada.primary_matedu, data = complete_ndd,
                    family = "binomial")
summary(MV_wi_INTlogit)

table(complete_ndd$WI_quintile)
class(complete_ndd$WI_quintile)
table(complete_ndd$ndd_ada.primary_matedu)
class(complete_ndd$ndd_ada.primary_matedu)

```



## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
